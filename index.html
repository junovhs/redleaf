<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="UTF-8">
  <title>Redleaf OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Link to Google Fonts for 'Press Start 2P' -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet">
  
  <style>
    /* CSS Variables for Maintainability */
    :root {
      --background-color: #041317;
      --primary-color: #B04438;
      --text-color: #CDCCBB;
      --border-color: #CDCCBB;
      --font-family: 'Press Start 2P', 'Courier New', monospace;
      --cursor-color: #CDCCBB;
      --hover-background: #B04438;
      --focus-outline: 2px solid #FFFFFF;
    }

    /* Reset and Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--background-color);
      font-family: var(--font-family);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: var(--text-color);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Skip Link Styles */
    .skip-link {
      position: absolute;
      top: 0;
      left: 0;
      background: var(--primary-color);
      color: #FFFFFF;
      padding: 8px;
      transform: translateY(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
      text-decoration: none;
    }

    .skip-link:focus {
      transform: translateY(0);
    }

    /* Navbar Styles */
    .navbar {
      background: var(--primary-color);
      color: var(--text-color);
      padding: 8px;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
      margin-bottom: 8px;
      border: 4px solid var(--border-color);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      position: relative;
      width: 100%;
      cursor: pointer; /* Indicates it's clickable */
    }

    /* Hide the hamburger button */
    .navbar-toggle {
      display: none;
    }

    .nav-expand-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin-left: auto; /* Push to the right */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      image-rendering: pixelated;
      pointer-events: none; /* Does not interfere with clicks */
    }

    /* Pixel-Style Arrow using CSS */
    .nav-expand-toggle::before {
      content: "";
      display: block;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid var(--text-color);
      transition: transform 0.3s ease;
    }

    .nav-expand-toggle.expanded::before {
      border-top: none;
      border-bottom: 8px solid var(--text-color);
      transform: rotate(180deg);
    }

    /* Navbar Inner (Collapsible Section) */
    .navbar-inner {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      width: 100%;
      background-color: var(--background-color); /* Match main background */
      transition: max-height 0.3s ease-in-out;
      overflow: hidden;
      max-height: 0; /* Collapsed by default */
    }

    .navbar-inner.expanded {
      max-height: 1000px; /* Sufficient to display all items */
    }

    /* Navigation Items */
    .nav-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      width: 100%;
      background-color: var(--background-color); /* Match main background */
      padding: 8px;
    }

    .nav-item {
      color: var(--text-color);
      text-decoration: none;
      padding: 8px 16px;
      font-size: 14px;
      background: var(--background-color);
      border: 4px solid var(--border-color);
      cursor: pointer;
      transition: all 0.1s;
      white-space: nowrap;
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 4px; /* Prevent clipping on hover */
    }

    .nav-item.has-dropdown {
      background: var(--background-color); /* Match main background */
      position: relative;
      padding-right: 30px; /* Space for the arrow */
    }

    /* Dropdown Arrow Indicator */
    .nav-item.has-dropdown::after {
      content: ">";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-color);
      font-family: var(--font-family);
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    /* Change arrow to V when dropdown is open */
    .nav-item.has-dropdown.open::after {
      content: "V";
      transform: translateY(-50%) rotate(0deg);
    }

    /* Hover and Focus States */
    .nav-item.has-dropdown:hover,
    .nav-item.has-dropdown:focus {
      background: var(--hover-background);
    }

    .nav-item.has-dropdown:hover::after,
    .nav-item.has-dropdown:focus::after {
      color: #FFFFFF;
    }

    .nav-item:hover,
    .nav-item:focus {
      background: var(--hover-background);
      transform: scale(1.05);
      outline: none;
    }

    .nav-item:active {
      transform: scale(0.95);
      background: var(--hover-background);
    }

    .nav-item.has-dropdown {
      position: relative;
      z-index: 10; /* Ensure dropdown is above others */
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--background-color);
      border: 4px solid var(--border-color);
      z-index: 1000; /* Stay above everything else */
      min-width: 200px;
      padding: 4px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.8); /* Better visibility */
      transition: visibility 0.3s ease-in-out, opacity 0.3s ease-in-out;
      opacity: 0; /* Initially hidden */
      visibility: hidden; /* Initially hidden */
    }

    .nav-item.has-dropdown:hover .dropdown-content,
    .nav-item.has-dropdown.open .dropdown-content {
      display: block; /* Show when active */
      opacity: 1; /* Fully visible */
      visibility: visible;
      z-index: 1001; /* Ensure dropdown is on top */
    }

    .dropdown-item {
      color: var(--text-color);
      padding: 8px 16px;
      text-decoration: none;
      background: var(--background-color);
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: block;
    }

    .dropdown-item:hover,
    .dropdown-item:focus {
      background: var(--hover-background);
      outline: none;
    }

    /* Main Content Styles */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--background-color);
      padding: 20px;
      border: 4px solid var(--border-color);
      margin: 10px;
    }

    #content-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--background-color);
      border: 4px solid var(--border-color);
      padding: 20px; /* Better whitespace */
    }

    #content-frame {
      flex: 1;
      width: 100%;
      border: none;
      min-height: 500px;
      background: var(--background-color);
      loading: lazy; /* Optimize loading */
      display: none;
    }

    #home-content {
      padding: 20px;
      color: var(--text-color);
      font-family: var(--font-family);
      line-height: 1.6; /* Better readability */
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      overflow: hidden; /* Needed for typewriter effect */
    }

    /* Typewriter Cursor */
    .cursor {
      display: inline-block;
      background-color: var(--cursor-color);
      width: 10px;
      margin-left: 2px;
      animation: blink 1s steps(5, start) infinite;
      height: 1em; /* Match text height */
      vertical-align: bottom;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    /* Footer Styles */
    footer {
      background: var(--background-color);
      color: var(--text-color);
      text-align: center;
      padding: 1rem;
      border-top: 4px solid var(--border-color);
    }

    #loading {
      text-align: center;
      padding: 1rem;
      color: var(--text-color);
      display: none;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      /* Adjust the nav-expand-toggle for mobile */
      .nav-expand-toggle {
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        display: block; /* Always visible */
      }

      .navbar-inner {
        flex-direction: column;
        max-height: 0;
      }

      .navbar-inner.expanded {
        max-height: 1000px;
      }

      .nav-items {
        flex-direction: column;
        width: 100%;
      }

      .nav-item {
        flex: 1 1 100%;
      }

      .dropdown-content {
        position: relative;
        top: auto;
        left: auto;
        z-index: 1001;
      }
    }

    @media (min-width: 769px) {
      .nav-item {
        flex: 1 1 auto;
      }

      .nav-expand-toggle {
        margin-left: 8px;
      }
    }

    /* Prevent Navigation Overflow */
    .navbar-inner {
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Skip to Main Content Link -->
  <a href="#content-container" class="skip-link">Skip to main content</a>

  <header>
    <div class="container">
      <nav class="navbar">
        <span>Redleaf OS - Tools Initialized</span>
        <button class="nav-expand-toggle" aria-label="Expand/Collapse Navigation">
        </button>
      </nav>
      <div class="navbar-inner">
        <div class="nav-items" id="navbar">
          <!-- Dynamic nav items will be inserted here -->
        </div>
      </div>
    </div>
  </header>
  
  <main>
    <div id="content-container">
      <div id="home-content">
        <span id="typewriter-text"></span><span class="cursor"></span>
      </div>
      <iframe id="content-frame" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    <div id="loading">Loading...</div>
  </main>
  
  <footer>
    <p>Â© 2024 Redleaf</p>
  </footer>
  
  <script>
    // JavaScript Code for Dynamic Navigation and Content Loading

    // DOM Elements
    const navbar = document.getElementById('navbar');
    const contentFrame = document.getElementById('content-frame');
    const homeContent = document.getElementById('home-content');
    const loading = document.getElementById('loading');
    const navExpandToggle = document.querySelector('.nav-expand-toggle');

    // State Variables
    let isLoading = false;
    let availablePages = [];

    // Determine Hosting Environment
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const repoName = 'redleaf'; // Replace with your repository name if different
    const basePath = isLocal ? '/' : `/${repoName}/`;

    // Set base href dynamically
    document.querySelector('base').setAttribute('href', basePath);

    // Typewriter Content for Home Page
    const typewriterContent = `
      <p>Welcome to Redleaf OS!</p>
      <p>A creative space by Spencer Nunamaker, where innovation meets functionality. This site is all about sharing tools, coding projects, and fun ideas designed to make life easier and more enjoyable. Whether you're here to streamline your workflow or explore new possibilities, there's plenty to discover.</p>
    `;

    // Typewriter Effect Function
    function typeWriter(text, element, speed) {
      let i = 0;
      const length = text.length;
      element.innerHTML = ''; // Clear initial content

      function type() {
        if (i < length) {
          // Handle HTML tags
          if (text.charAt(i) === '<') {
            const endTag = text.indexOf('>', i);
            if (endTag !== -1) {
              const tag = text.substring(i, endTag + 1);
              element.innerHTML += tag;
              i = endTag + 1;
              type();
              return;
            }
          }

          // Add new character
          element.innerHTML += text.charAt(i);
          i++;
          setTimeout(type, speed);
        } else {
          // Hide cursor after typing is complete
          document.querySelector('.cursor').style.display = 'none';
        }
      }

      type();
    }

    // Fetch Pages from GitHub API
    async function fetchPages() {
      if (isLocal) {
        console.warn('Local fetching is not implemented.');
        return [];
      } else {
        try {
          // Check if pages are cached
          const cachedPages = localStorage.getItem('pagesList');
          if (cachedPages) {
            const cacheData = JSON.parse(cachedPages);
            const oneHour = 60 * 60 * 1000;
            if (Date.now() - cacheData.timestamp < oneHour) {
              cacheData.pages.forEach(page => {
                if (page.type === 'file') {
                  availablePages.push(`pages/${page.name}.html`);
                } else if (page.type === 'folder') {
                  page.files.forEach(file => availablePages.push(`pages/${page.name}/${file.name}.html`));
                }
              });
              return cacheData.pages;
            }
          }

          // Fetch pages from GitHub API
          const apiUrl = `https://api.github.com/repos/${getRepoOwner()}/${repoName}/contents/pages`;
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error('Failed to fetch pages list');

          const items = await response.json();
          const pages = [];

          for (const item of items) {
            if (item.type === 'file' && item.name.endsWith('.html')) {
              const pageName = item.name.replace('.html', '');
              pages.push({ type: 'file', name: pageName, path: `pages/${item.name}` });
              availablePages.push(`pages/${item.name}`);
            } else if (item.type === 'dir') {
              const folderResponse = await fetch(item.url);
              if (!folderResponse.ok) throw new Error(`Failed to fetch folder ${item.name}`);
              const folderContents = await folderResponse.json();
              const htmlFiles = folderContents
                .filter(file => file.name.endsWith('.html'))
                .map(file => ({
                  name: file.name.replace('.html', ''),
                  path: `pages/${item.name}/${file.name}`
                }));
              if (htmlFiles.length > 0) {
                pages.push({ type: 'folder', name: item.name, files: htmlFiles });
                htmlFiles.forEach(file => availablePages.push(file.path));
              }
            }
          }

          // Cache the pages list with a timestamp
          const cacheData = {
            timestamp: Date.now(),
            pages: pages
          };
          localStorage.setItem('pagesList', JSON.stringify(cacheData));

          return pages;
        } catch (error) {
          console.error('Error fetching pages:', error);
          // Attempt to use cached pages if available despite being expired
          const cachedPages = localStorage.getItem('pagesList');
          if (cachedPages) {
            const cacheData = JSON.parse(cachedPages);
            cacheData.pages.forEach(page => {
              if (page.type === 'file') {
                availablePages.push(`pages/${page.name}.html`);
              } else if (page.type === 'folder') {
                page.files.forEach(file => availablePages.push(`pages/${page.name}/${file.name}.html`));
              }
            });
            return cacheData.pages;
          }
          return [];
        }
      }
    }

    // Helper Function to Get Repository Owner
    function getRepoOwner() {
      // Extract repository owner from GitHub Pages URL
      // Assumes the site is hosted at https://<owner>.github.io/<repo>/
      const pathParts = window.location.pathname.split('/').filter(part => part);
      return pathParts[0] || 'your-github-username'; // Replace with your GitHub username if necessary
    }

    // Create Navigation Links Based on Fetched Pages
    function createNavLinks(pages) {
      const navbar = document.getElementById('navbar');
      navbar.innerHTML = '';

      pages.forEach(page => {
        if (page.type === 'file') {
          const navItem = document.createElement('a');
          navItem.className = 'nav-item';
          navItem.textContent = page.name;
          navItem.href = `#${page.name}`;
          navItem.setAttribute('aria-label', `Navigate to ${page.name}`);
          navbar.appendChild(navItem);
        } else if (page.type === 'folder') {
          const folderNav = document.createElement('div');
          folderNav.className = 'nav-item has-dropdown';
          folderNav.textContent = page.name;
          folderNav.setAttribute('aria-haspopup', 'true');
          folderNav.setAttribute('aria-expanded', 'false');
          folderNav.tabIndex = 0; // Make focusable

          const dropdown = document.createElement('div');
          dropdown.className = 'dropdown-content';
          dropdown.setAttribute('role', 'menu');

          page.files.forEach(file => {
            const dropdownItem = document.createElement('a');
            dropdownItem.className = 'dropdown-item';
            dropdownItem.textContent = file.name;
            dropdownItem.href = `#${file.name}`;
            dropdownItem.setAttribute('role', 'menuitem');
            dropdownItem.setAttribute('aria-label', `Navigate to ${file.name}`);
            dropdown.appendChild(dropdownItem);
          });

          folderNav.appendChild(dropdown);

          // Event Listeners for Accessibility (Keyboard)
          folderNav.addEventListener('click', (event) => {
            event.preventDefault();
            toggleDropdown(folderNav);
          });

          folderNav.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              toggleDropdown(folderNav);
            }
          });

          navbar.appendChild(folderNav);
        }
      });
    }

    // Toggle Dropdown Function
    function toggleDropdown(folderNav) {
      const isOpen = folderNav.classList.toggle('open');
      folderNav.setAttribute('aria-expanded', isOpen);
    }

    // Navigate to a Specific Page by Updating the Hash
    function navigateTo(pageName) {
      window.location.hash = pageName;
      // The hashchange event will handle loading the content
    }

    // Load Content Based on the Current Page
    async function loadContent(pageName) {
      if (isLoading) return;
      isLoading = true;
      loading.style.display = 'block';

      try {
        if (pageName === 'home' || !availablePages.includes(`pages/${pageName}.html`)) {
          contentFrame.style.display = 'none';
          homeContent.style.display = 'block';

          if (pageName === 'home' || pageName === '') {
            // Clear existing content
            homeContent.innerHTML = '';

            // Start the typewriter effect
            typeWriter(typewriterContent, homeContent, 40); // Adjust speed as necessary (40ms per character)
          } else {
            // Display error message with typewriter effect
            const errorContent = `<p>The requested page "${pageName}" was not found. Please check the navigation menu and try again.</p>`;
            typeWriter(errorContent, homeContent, 25); // Faster speed for error messages
          }
        } else {
          homeContent.style.display = 'none';
          contentFrame.style.display = 'block';
          const response = await fetch(`pages/${pageName}.html`);
          if (!response.ok) throw new Error('Failed to fetch page content');
          const html = await response.text();
          contentFrame.srcdoc = html;
        }
      } catch (error) {
        console.error('Error loading content:', error);
        homeContent.style.display = 'block';
        homeContent.innerHTML = `<p>Failed to load content. Please try again.</p>`;
      } finally {
        loading.style.display = 'none';
        isLoading = false;
      }
    }

    // Handle Hash Changes to Load Appropriate Content
    function handleHashChange() {
      const hash = window.location.hash.substring(1); // Remove the '#' character
      const pageName = hash || 'home';
      loadContent(pageName);
    }

    // Expand/Collapse Toggle for Navigation (for mobile)
    document.querySelector('.navbar').addEventListener('click', () => {
      const navbarInner = document.querySelector('.navbar-inner');
      const navExpandToggle = document.querySelector('.nav-expand-toggle');
      navbarInner.classList.toggle('expanded');
      navExpandToggle.classList.toggle('expanded');
    });

    // Close Dropdowns When Clicking Outside
    document.addEventListener('click', function(event) {
      const isClickInsideNavbar = navbar.contains(event.target) || navExpandToggle.contains(event.target);
      if (!isClickInsideNavbar) {
        const dropdowns = document.querySelectorAll('.nav-item.has-dropdown.open');
        dropdowns.forEach(dropdown => {
          dropdown.classList.remove('open');
          dropdown.setAttribute('aria-expanded', 'false');
        });
      }
    });

    // Listen for Hash Changes
    window.addEventListener('hashchange', handleHashChange);

    // Handle Initial Load Based on the Current Hash
    window.addEventListener('DOMContentLoaded', () => {
      handleHashChange();
    });

    // Initialize Navigation Links with Fetched Pages
    (async () => {
      const pages = await fetchPages();
      createNavLinks(pages);
    })();
  </script>
</body>
</html>
