<html>
<head>
    <base href="https://junovhs.github.io/redleaf/" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redleaf</title>
    <!-- Link to Google Fonts for 'Press Start 2P' -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #041317;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #CDCCBB;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .navbar {
            background-color: #041317;
            border: 4px solid #CDCCBB;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 70px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            image-rendering: pixelated;
            position: relative;
        }

        .navbar-inner {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: flex-start;
            width: 100%;
            background-color: #041317;
        }

        .nav-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: flex-start;
            min-height: 100%;
            margin: 0px;
            background: #041317;
            flex: 1;
        }

        .nav-item {
            color: #CDCCBB;
            text-decoration: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: normal;
            position: relative;
            height: auto;
            display: flex;
            align-items: center;
            background: #041317;
            border: 4px solid #CDCCBB;
            cursor: pointer;
            transition: all 0.1s;
            white-space: nowrap;
            z-index: 1;
        }

        .nav-item:hover {
            background: #B04438;
            transform: scale(1.05);
        }

        .nav-item:active {
            transform: scale(0.95);
            background: #B04438;
        }

        .nav-item.has-dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #041317;
            border: 4px solid #CDCCBB;
            z-index: 1000;
            min-width: 200px;
            padding: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .nav-item.has-dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            color: #CDCCBB;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            background: #041317;
            border: none;
            margin: 4px 0;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #B04438;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #041317;
            padding: 20px;
            border: 4px solid #CDCCBB;
            margin: 10px;
        }

        #content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #041317;
            border: 4px solid #CDCCBB;
            padding: 4px;
        }

        #content-frame {
            flex: 1;
            width: 100%;
            border: none;
            min-height: 500px;
            background: #041317;
        }

        #home-content {
            padding: 20px;
            color: #CDCCBB;
            font-family: 'Press Start 2P', monospace;
        }

        footer {
            background: #041317;
            color: #CDCCBB;
            text-align: center;
            padding: 1rem;
            border-top: 4px solid #CDCCBB;
        }

        #loading {
            text-align: center;
            padding: 1rem;
            color: #CDCCBB;
        }

        .title-bar {
            background: #B04438;
            color: #CDCCBB;
            padding: 8px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            margin-bottom: 8px;
            border: 4px solid #CDCCBB;
            text-transform: uppercase;
        }

        .dropdown-content {
            scrollbar-width: thin;
            scrollbar-color: #B04438 #041317;
        }

        .dropdown-content::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-content::-webkit-scrollbar-track {
            background: #041317;
        }

        .dropdown-content::-webkit-scrollbar-thumb {
            background-color: #B04438;
            border: 2px solid #041317;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 4px;
            }

            .nav-item {
                font-size: 12px;
                padding: 6px 12px;
            }

            .logo {
                height: 25px;
            }

            .dropdown-content {
                min-width: 150px;
            }
        }
    </style>
    <script>
        (function() {
            var redirect = sessionStorage.redirect;
            delete sessionStorage.redirect;
            if (redirect && redirect != location.href) {
                history.replaceState(null, null, redirect);
            }
        })();
    </script>
</head>
<body>
    <header>
        <div class="container">
            <div class="title-bar">Redleaf - Windows 98</div>
            <nav class="navbar">
                <div class="navbar-inner">
                    <a href="https://junovhs.github.io/redleaf/">
                        <img src="https://raw.githubusercontent.com/junovhs/redleaf/main/assets/redleaf_logo.svg" alt="Logo" class="logo">
                    </a>
                    <div class="nav-items" id="navbar">
                        <!-- Dynamic nav items will be inserted here -->
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <main>
        <div id="content-container">
            <div id="home-content"></div>
            <iframe id="content-frame" sandbox="allow-scripts allow-same-origin" style="display:none;"></iframe>
        </div>
        <div id="loading" style="display:none;">Loading...</div>
    </main>
    <footer>
        <p>&copy; 2024 Redleaf</p>
    </footer>
    <script>
        const navbar = document.getElementById('navbar');
        const contentFrame = document.getElementById('content-frame');
        const homeContent = document.getElementById('home-content');
        const loading = document.getElementById('loading');
        let isLoading = false;
        let availablePages = [];

        // Determine the base path based on the environment
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const basePath = isLocal ? '/' : '/redleaf/';

        async function fetchPages() {
            if (isLocal) {
                try {
                    const response = await fetch('pages/');
                    if (!response.ok) throw new Error('Failed to fetch local pages directory');
                    const text = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const links = Array.from(doc.querySelectorAll('a'));
                    const pages = [];
                    
                    for (const link of links) {
                        const href = link.getAttribute('href');
                        if (href.endsWith('.html')) {
                            pages.push({
                                type: 'file',
                                name: href.replace('.html', ''),
                                path: `pages/${href}`
                            });
                            availablePages.push(`pages/${href}`);
                        } else if (href.endsWith('/')) {
                            const folderName = href.replace('/', '');
                            const folderResponse = await fetch(`pages/${href}`);
                            if (!folderResponse.ok) throw new Error(`Failed to fetch folder ${href}`);
                            const folderText = await folderResponse.text();
                            const folderDoc = parser.parseFromString(folderText, 'text/html');
                            const folderLinks = Array.from(folderDoc.querySelectorAll('a'));
                            const htmlFiles = folderLinks
                                .filter(a => a.getAttribute('href').endsWith('.html'))
                                .map(a => ({
                                    name: a.getAttribute('href').replace('.html', ''),
                                    path: `pages/${href}${a.getAttribute('href')}`
                                }));
                            
                            if (htmlFiles.length > 0) {
                                pages.push({
                                    type: 'folder',
                                    name: folderName,
                                    files: htmlFiles
                                });
                                htmlFiles.forEach(file => availablePages.push(file.path));
                            }
                        }
                    }
                    return pages;
                } catch (error) {
                    console.error('Error fetching local pages:', error);
                    return [];
                }
            } else {
                try {
                    const response = await fetch('https://api.github.com/repos/junovhs/redleaf/contents/pages');
                    if (!response.ok) throw new Error('Failed to fetch pages list');
                    const items = await response.json();
                    const pages = [];

                    for (const item of items) {
                        if (item.type === 'file' && item.name.endsWith('.html')) {
                            pages.push({
                                type: 'file',
                                name: item.name.replace('.html', ''),
                                path: `pages/${item.name}`
                            });
                            availablePages.push(`pages/${item.name}`);
                        } else if (item.type === 'dir') {
                            const folderResponse = await fetch(item.url);
                            if (!folderResponse.ok) throw new Error('Failed to fetch folder contents');
                            const folderContents = await folderResponse.json();
                            const htmlFiles = folderContents
                                .filter(file => file.name.endsWith('.html'))
                                .map(file => ({
                                    name: file.name.replace('.html', ''),
                                    path: `pages/${item.name}/${file.name}`
                                }));
                            
                            if (htmlFiles.length > 0) {
                                pages.push({
                                    type: 'folder',
                                    name: item.name,
                                    files: htmlFiles
                                });
                                htmlFiles.forEach(file => availablePages.push(file.path));
                            }
                        }
                    }
                    return pages;
                } catch (error) {
                    console.error('Error fetching pages:', error);
                    return [];
                }
            }
        }

        function createNavLinks(pages) {
            navbar.innerHTML = '';
            const homeButton = document.createElement('div');
            homeButton.className = 'nav-item';
            homeButton.setAttribute('data-page', 'home');
            homeButton.textContent = 'Home';
            navbar.appendChild(homeButton);

            const sortedPages = [...pages].sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'file' ? -1 : 1;
            });
            
            sortedPages.forEach(page => {
                if (page.type === 'file') {
                    const navItem = document.createElement('div');
                    navItem.className = 'nav-item';
                    navItem.setAttribute('data-page', page.path);
                    navItem.textContent = page.name;
                    navbar.appendChild(navItem);
                } else if (page.type === 'folder') {
                    const folderNav = document.createElement('div');
                    folderNav.className = 'nav-item has-dropdown';
                    folderNav.textContent = page.name;
                    
                    const dropdown = document.createElement('div');
                    dropdown.className = 'dropdown-content';
                    
                    const sortedFiles = [...page.files].sort((a, b) => 
                        a.name.localeCompare(b.name)
                    );
                    
                    sortedFiles.forEach(file => {
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'dropdown-item';
                        dropdownItem.setAttribute('data-page', file.path);
                        dropdownItem.textContent = file.name;
                        dropdown.appendChild(dropdownItem);
                    });
                    
                    folderNav.appendChild(dropdown);
                    navbar.appendChild(folderNav);
                }
            });
            
            navbar.addEventListener('click', handleNavClick);
            checkNavOverflow();
        }

        function checkNavOverflow() {
            const navbar = document.querySelector('.navbar');
            const navItems = navbar.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.style.fontSize = '';
            });
            if (navbar.scrollWidth > navbar.clientWidth) {
                const currentSize = parseInt(window.getComputedStyle(navItems[0]).fontSize);
                const newSize = Math.max(currentSize * 0.9, 10);
                navItems.forEach(item => {
                    item.style.fontSize = `${newSize}px`;
                });
            }
        }

        function handleNavClick(event) {
            const target = event.target;
            if (target.classList.contains('nav-item') || target.classList.contains('dropdown-item')) {
                const pagePath = target.getAttribute('data-page');
                if (pagePath) {
                    navigateTo(pagePath);
                }
            }
        }

        function navigateTo(pagePath) {
            const isHome = pagePath === 'home';
            const url = isHome ? `${basePath}` : `${basePath}${pagePath}`;
            history.pushState({ pagePath }, '', url);
            loadContent(pagePath);
        }

        async function loadContent(pagePath) {
            if (isLoading) return;
            isLoading = true;
            loading.style.display = 'block';

            try {
                if (pagePath === 'home' || !availablePages.includes(pagePath)) {
                    contentFrame.style.display = 'none';
                    homeContent.style.display = 'block';
                    homeContent.innerHTML = '<h1>Welcome to Redleaf</h1><p>Select a page from the navigation menu.</p>';
                    if (pagePath !== 'home' && pagePath !== '') {
                        homeContent.innerHTML += `<p>The requested page "${pagePath}" was not found.</p>`;
                    }
                } else {
                    homeContent.style.display = 'none';
                    contentFrame.style.display = 'block';
                    const response = await fetch(pagePath);
                    if (!response.ok) throw new Error('Failed to fetch page content');
                    
                    const html = await response.text();
                    contentFrame.srcdoc = html;
                }
            } catch (error) {
                console.error('Error loading content:', error);
                homeContent.style.display = 'block';
                homeContent.innerHTML = '<h1>Error</h1><p>Failed to load content. Please try again.</p>';
            } finally {
                loading.style.display = 'none';
                isLoading = false;
            }
        }

        function handleRoute() {
            const path = window.location.pathname.replace(basePath, '');
            const fullPath = path === '' ? 'home' : path;
            loadContent(fullPath);
        }

        window.addEventListener('popstate', handleRoute);

        // Initialize
        (async () => {
            const pages = await fetchPages();
            createNavLinks(pages);
            handleRoute();
        })();
    </script>
</body>
</html>
